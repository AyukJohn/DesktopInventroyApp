<template>
    <div class="dashboard container mt-5">
      <div class="title">
        <h2>Analytics</h2>
      </div>
  
        <div class="row">
            <div class="col-md-6">
            <h5>Sales Performance</h5>
            <div class="card chart-card mt-4" style="min-width: 400px;">
                <h6>Activity</h6>
                <canvas id="salesChart"></canvas>
            </div>
            </div>
    
            <div class="col-md-6">
            <div v-if="!hasData" class="no-data">
                <p>No Data Available</p>
            </div>
    
                <div class="d-flex">
                    
                    <div>
                    <h6>Best Selling Product</h6>
                    <div class="card mt-4" v-if="bestSellingProduct" style="min-width: 200px;">
                        <p class="nametext">{{ bestSellingProduct.name }}</p>
                        <p class="percentage">{{ leastSellingProduct.percentage }}%</p>
                    </div>
                    </div>
        
                    <div>
                    <h6 class="ps-4">Least Selling Product</h6>
                    <div class="card ms-4 mt-4" v-if="leastSellingProduct" style="min-width: 200px;">
                        <p class="nametext">{{ leastSellingProduct.name }}</p>
                        <p class="percentage">{{ leastSellingProduct.percentage }}%</p>
                    </div>
                    </div>
        
                </div>
            </div>
        </div>
  

        <div class="mt-5">
            <ul class="table-list">
            <li class="ms-3 cursor-pointer" @click="filterCategory('all')"><span>All</span></li>
            <li @click="filterCategory('fragrance')" class="cursor-pointer"><span>Fragrance Family</span></li>
            <li @click="filterCategory('gender')" class="cursor-pointer"><span>Gender</span></li>
            </ul>
        </div>
  
        <div class="mt-4" v-if="selectedCategory === 'fragrance'">
            <ul class="table-list2">
            <li class="ms-4" @click="filterSubCategory('woody')"><span>woody</span></li>
            <li class="ms-3" @click="filterSubCategory('floral')"><span>floral</span></li>
            <li class="ms-3" @click="filterSubCategory('seduction')"><span>seduction</span></li>
            </ul>
        </div>
  
        <div class="mt-4" v-if="selectedCategory === 'gender'">
            <ul class="table-list2">
            <li class="ms-4" @click="filterSubCategory('male')"><span>male</span></li>
            <li class="ms-3" @click="filterSubCategory('female')"><span>female</span></li>
            </ul>
        </div>
  
        <div class="row row-cols-1 row-cols-md-4 g-4 mt-5">
            <div v-if="filteredProductList.length === 0" class="no-products">
            <p>No products found.</p>
            </div>
            <div v-for="product in filteredProductList" :key="product.i">
            <div class="col">
                <div class="card h-100">
                <div class="card-body">
                    <div class="header-row d-flex align-items-center justify-content-between">
                    <span class="info" @click="openUpdateModal(product)" data-bs-toggle="modal" data-bs-target="#productInfoModal">
                        <img src="/info.svg" alt="Info Icon" class="img-fluid" />
                    </span>
                    <span class="productName">
                        <p class="mb-0">{{ product.id }}</p>
                    </span>
                    <span class="cancel" @click="deleteProductInfo(selectedProduct.id)">
                        <img src="/cancel.svg" alt="Cancel Icon" class="img-fluid" />
                    </span>
                    </div>
                    <p class="card-text mt-3">{{ product.description }}</p>
                    <div class="stockHolder d-flex align-items-center justify-content-between">
                    <div class="stockHolder1">
                        <h6>SKU:</h6>
                        <h6 class="sub text-muted">{{ product.reference }}</h6>
                    </div>
                    <div class="stockHolder2">
                        <h6>STOCK UNIT:</h6>
                        <h6 class="sub text-muted">{{ product.productInventory }}</h6>
                    </div>
                    </div>
                </div>
                </div>
            </div>
            </div>
        </div>


    </div>
  </template>
  
  
  
  
  
  
  
  <script>
  import { defineComponent, ref, computed, onMounted } from 'vue';
  import { openSalesDB, getAllSales } from '../utils/salesDB';
  import { openDB, getAllProducts } from '../utils/indexDB';
  import Chart from 'chart.js/auto';
  
  export default defineComponent({
    setup() {
      // Reactive references
      const bestSellingProduct = ref(null);
      const leastSellingProduct = ref(null);
      const hasData = ref(false);
      const selectedCategory = ref('all');
      const selectedSubCategory = ref('');
      const products = ref([]);
      const salesData = ref([]);
  
      // Fetch all products from IndexedDB
      const fetchProducts = async () => {
        try {
          const db = await openDB(); // Open IndexedDB connection
          products.value = await getAllProducts(db); // Fetch all products
          console.log('Fetched Products:', products.value);  // Log to check if products are fetched correctly
          hasData.value = products.value.length > 0; // Check if data exists
        } catch (error) {
          console.error('Error fetching products:', error);
        }
      };
  
      // Fetch all sales data from IndexedDB
      const fetchSalesData = async () => {
        try {
          const db = await openSalesDB(); // Open Sales DB connection
          salesData.value = await getAllSales(db); // Fetch sales data
          console.log('Fetched Sales Data:', salesData.value);  // Log to check if sales data is fetched correctly
          calculateBestAndLeastSelling(); // Process sales data
        } catch (error) {
          console.error('Error fetching sales data:', error);
        }
      };
  
      // Calculate best-selling and least-selling products
      const calculateBestAndLeastSelling = () => {
        if (salesData.value.length === 0) return;
  
        const productSales = {};
  
        // Aggregate sales by product ID
        salesData.value.forEach((sale) => {
          console.log('Sale:', sale);  // Log sale to verify productId and quantity
          productSales[sale.productId] = (productSales[sale.productId] || 0) + sale.quantity;
        });
  
        const sortedSales = Object.entries(productSales).sort((a, b) => b[1] - a[1]);
  
        console.log('Sorted Sales:', sortedSales);  // Log to verify sorting
  
        if (sortedSales.length > 0) {
          const [bestProductId, bestSales] = sortedSales[0];
          const [leastProductId, leastSales] = sortedSales[sortedSales.length - 1];
  
          // Log the best and least selling products
          console.log('Best Product:', bestProductId, bestSales);
          console.log('Least Product:', leastProductId, leastSales);
  
          // Find corresponding product details
          bestSellingProduct.value = products.value.find((product) => product.id === bestProductId);
          leastSellingProduct.value = products.value.find((product) => product.id === leastProductId);
  
          if (bestSellingProduct.value) {
            bestSellingProduct.value.percentage = ((bestSales / salesData.value.length) * 100).toFixed(2);
          }
  
          if (leastSellingProduct.value) {
            leastSellingProduct.value.percentage = ((leastSales / salesData.value.length) * 100).toFixed(2);
          }
        }
      };
  
      // Filtered products list based on selected category and subcategory
      const filteredProductList = computed(() => {
        if (selectedCategory.value === 'all') return products.value;
  
        return products.value.filter((product) => {
          if (selectedCategory.value === 'gender' && selectedSubCategory.value) {
            return product.gender === selectedSubCategory.value;
          }
  
          if (selectedCategory.value === 'fragrance' && selectedSubCategory.value) {
            return product.fragranceFamily === selectedSubCategory.value;
          }
  
          return true;
        });
      });
  
      // Filter products by category
      const filterCategory = (category) => {
        selectedCategory.value = category;
        selectedSubCategory.value = '';
      };
  
      // Filter products by subcategory
      const filterSubCategory = (subCategory) => {
        selectedSubCategory.value = subCategory;
      };
  
      // Initialize sales chart
      const initSalesChart = () => {
        if (!salesData.value || salesData.value.length === 0) {
          console.error('Sales data is empty or not available.');
          return;
        }
  
        const ctx = document.getElementById('salesChart');
        if (!ctx) {
          console.error('Chart canvas not found!');
          return;
        }
  
        new Chart(ctx, {
          type: 'line',
          data: {
            labels: salesData.value.map((sale) => sale.date), // X-axis labels (dates)
            datasets: [
              {
                label: 'Sales Quantity',
                data: salesData.value.map((sale) => sale.quantity), // Y-axis data
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                borderColor: 'rgba(75, 192, 192, 1)',
                borderWidth: 1,
              },
            ],
          },
          options: {
            responsive: true,
            scales: {
              x: { title: { display: true, text: 'Date' } },
              y: { title: { display: true, text: 'Quantity' } },
            },
          },
        });
      };
  
      // Lifecycle hook: Fetch data and initialize chart
      onMounted(async () => {
        console.log('Component mounted, fetching data...');
        await fetchProducts();
        await fetchSalesData(); // Fetch sales data and process
        if (salesData.value.length > 0) {
          calculateBestAndLeastSelling(); // Calculate best and least selling products
          initSalesChart(); // Initialize chart only after data is processed
        } else {
          console.log('No sales data available.');
        }
      });
  
      return {
        bestSellingProduct,
        leastSellingProduct,
        hasData,
        selectedCategory,
        selectedSubCategory,
        filteredProductList,
        filterCategory,
        filterSubCategory,
      };
    },
  });
  </script>
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  <style scoped>
  .cards {
    display: flex;
    flex-wrap: wrap;
    gap: 20px;
  }
  
  .card {
    flex: 1;
    padding: 20px;
    border: none;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    position: relative;
  }
  
  .chart-card {
    border: none;
    border-radius: 8px;
    box-shadow: 0 2px 4px 8px rgba(0, 0, 0, 0.1);
    padding: 20px;
  }
  
  .card h2 {
    margin-bottom: 10px;
  }
  
  .card p {
    margin-bottom: 10px;
  }
  
  .no-data {
    text-align: center;
    font-size: 18px;
    color: #888;
  }
  
  .revenucard {
    max-width: 200px;
  }
  
  .nametext {
    font-weight: 100;
    font-size: small;
  }
  </style>